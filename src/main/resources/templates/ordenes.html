<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">AutoFixPro - Órdenes de Servicio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .orden-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .orden-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .badge-estado {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
        .badge-prioridad {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar text-white p-3">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-wrench fa-2x me-2"></i>
                    <h4 class="mb-0">AutoFixPro</h4>
                </div>

                <nav class="nav flex-column">
                    <a class="nav-link text-white" href="/dashboard"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                    <a class="nav-link text-white" href="/api/clientes"><i class="fas fa-users me-2"></i>Clientes</a>
                    <a class="nav-link text-white" href="/vehiculos"><i class="fas fa-car me-2"></i>Vehículos</a>
                    <a class="nav-link text-white active" href="/ordenes"><i class="fas fa-clipboard-list me-2"></i>Órdenes</a>
                    <a class="nav-link text-white" href="#"><i class="fas fa-tools me-2"></i>Servicios</a>
                    <a class="nav-link text-white" href="/sms/cliente"><i class="fas fa-sms me-2"></i>Enviar SMS</a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-clipboard-list me-2"></i>Órdenes de Servicio</h2>
                    <div class="d-flex align-items-center gap-2">
                        <a href="/ordenes/nueva" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nueva Orden
                        </a>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-user me-1"></i> Admin
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/perfil"><i class="fas fa-user-cog me-2"></i>Perfil</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="post" action="/logout" style="display: inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="dropdown-item" style="cursor: pointer; border: none; background: none; width: 100%; text-align: left;">
                                            <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-filter me-2"></i>Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="">Todos los estados</option>
                                    <option value="RECIBIDO">Recibido</option>
                                    <option value="EN_DIAGNOSTICO">En Diagnóstico</option>
                                    <option value="EN_REPARACION">En Reparación</option>
                                    <option value="EN_PRUEBAS">En Pruebas</option>
                                    <option value="COMPLETADO">Completado</option>
                                    <option value="ENTREGADO">Entregado</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-exclamation-circle me-2"></i>Prioridad</label>
                                <select class="form-select" id="filtroPrioridad">
                                    <option value="">Todas las prioridades</option>
                                    <option value="BAJA">Baja</option>
                                    <option value="NORMAL">Normal</option>
                                    <option value="ALTA">Alta</option>
                                    <option value="URGENTE">Urgente</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-search me-2"></i>Buscar</label>
                                <input type="text" class="form-control" id="buscarOrden" placeholder="Buscar por vehículo, técnico...">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-secondary w-100" onclick="limpiarFiltros()">
                                    <i class="fas fa-times me-2"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Órdenes -->
                <div id="ordenesContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando órdenes de servicio...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api';
        let todasLasOrdenes = [];

        // Cargar órdenes al inicio
        document.addEventListener('DOMContentLoaded', function() {
            cargarOrdenes();

            // Eventos de filtros
            document.getElementById('filtroEstado').addEventListener('change', filtrarOrdenes);
            document.getElementById('filtroPrioridad').addEventListener('change', filtrarOrdenes);
            document.getElementById('buscarOrden').addEventListener('input', filtrarOrdenes);
        });

        // Función para cargar órdenes
        async function cargarOrdenes() {
            try {
                const response = await fetch(`${API_BASE_URL}/ordenes`);
                const data = await response.json();

                if (data.data && Array.isArray(data.data)) {
                    todasLasOrdenes = data.data;
                    mostrarOrdenes(todasLasOrdenes);
                } else {
                    mostrarMensaje('No hay órdenes de servicio registradas', 'info');
                }
            } catch (error) {
                console.error('Error al cargar órdenes:', error);
                mostrarMensaje('Error al cargar las órdenes de servicio', 'danger');
            }
        }

        // Función para mostrar órdenes
        function mostrarOrdenes(ordenes) {
            const container = document.getElementById('ordenesContainer');

            if (ordenes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                        <p class="text-muted">No se encontraron órdenes con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="row">';
            ordenes.forEach(orden => {
                const estadoClass = getEstadoClass(orden.estadoOrden);
                const prioridadClass = getPrioridadClass(orden.prioridad);
                const vehiculo = orden.vehiculo || {};
                const tecnico = orden.tecnico || {};

                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card orden-card h-100 border-0 shadow-sm" onclick="verDetalleOrden(${orden.ordenId})">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">Orden #${orden.ordenId}</h5>
                                    <span class="badge ${estadoClass} badge-estado">${formatEstado(orden.estadoOrden)}</span>
                                </div>
                                <span class="badge ${prioridadClass} badge-prioridad mb-3">${orden.prioridad}</span>

                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-car me-2"></i>Vehículo:</small>
                                    <div><strong>${vehiculo.placa || 'N/A'} - ${vehiculo.marca || ''} ${vehiculo.modelo || ''}</strong></div>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-user-tie me-2"></i>Técnico:</small>
                                    <div>${tecnico.nombres || 'Sin asignar'} ${tecnico.apellidos || ''}</div>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-calendar me-2"></i>Ingreso:</small>
                                    <div>${formatFecha(orden.fechaIngreso)}</div>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-dollar-sign me-2"></i>Costo estimado:</small>
                                    <div><strong>S/. ${orden.costoEstimado ? orden.costoEstimado.toFixed(2) : '0.00'}</strong></div>
                                </div>

                                <div class="mt-3">
                                    <small class="text-muted"><i class="fas fa-wrench me-2"></i>Problema:</small>
                                    <div class="text-truncate">${orden.descripcionProblema || 'Sin descripción'}</div>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-top-0">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="event.stopPropagation(); verDetalleOrden(${orden.ordenId})">
                                    <i class="fas fa-eye me-2"></i>Ver Detalles
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Función para filtrar órdenes
        function filtrarOrdenes() {
            const estado = document.getElementById('filtroEstado').value;
            const prioridad = document.getElementById('filtroPrioridad').value;
            const busqueda = document.getElementById('buscarOrden').value.toLowerCase();

            let ordenesFiltradas = todasLasOrdenes.filter(orden => {
                const cumpleEstado = !estado || orden.estadoOrden === estado;
                const cumplePrioridad = !prioridad || orden.prioridad === prioridad;

                const vehiculo = orden.vehiculo || {};
                const tecnico = orden.tecnico || {};
                const textoBusqueda = `${vehiculo.placa} ${vehiculo.marca} ${vehiculo.modelo} ${tecnico.nombres} ${tecnico.apellidos} ${orden.descripcionProblema}`.toLowerCase();
                const cumpleBusqueda = !busqueda || textoBusqueda.includes(busqueda);

                return cumpleEstado && cumplePrioridad && cumpleBusqueda;
            });

            mostrarOrdenes(ordenesFiltradas);
        }

        // Función para limpiar filtros
        function limpiarFiltros() {
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroPrioridad').value = '';
            document.getElementById('buscarOrden').value = '';
            mostrarOrdenes(todasLasOrdenes);
        }

        // Función para ver detalle de orden
        function verDetalleOrden(ordenId) {
            window.location.href = `/ordenes/${ordenId}`;
        }

        // Funciones de utilidad
        function getEstadoClass(estado) {
            const clases = {
                'RECIBIDO': 'bg-info',
                'EN_DIAGNOSTICO': 'bg-warning',
                'EN_REPARACION': 'bg-primary',
                'EN_PRUEBAS': 'bg-secondary',
                'COMPLETADO': 'bg-success',
                'ENTREGADO': 'bg-dark'
            };
            return clases[estado] || 'bg-secondary';
        }

        function getPrioridadClass(prioridad) {
            const clases = {
                'BAJA': 'bg-secondary',
                'NORMAL': 'bg-info',
                'ALTA': 'bg-warning',
                'URGENTE': 'bg-danger'
            };
            return clases[prioridad] || 'bg-secondary';
        }

        function formatEstado(estado) {
            const estados = {
                'RECIBIDO': 'Recibido',
                'EN_DIAGNOSTICO': 'En Diagnóstico',
                'EN_REPARACION': 'En Reparación',
                'EN_PRUEBAS': 'En Pruebas',
                'COMPLETADO': 'Completado',
                'ENTREGADO': 'Entregado'
            };
            return estados[estado] || estado;
        }

        function formatFecha(fecha) {
            if (!fecha) return 'N/A';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function mostrarMensaje(mensaje, tipo) {
            const container = document.getElementById('ordenesContainer');
            const iconos = {
                'info': 'fa-info-circle',
                'danger': 'fa-exclamation-triangle',
                'success': 'fa-check-circle'
            };
            container.innerHTML = `
                <div class="alert alert-${tipo} text-center" role="alert">
                    <i class="fas ${iconos[tipo]} fa-2x mb-2"></i>
                    <p class="mb-0">${mensaje}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
